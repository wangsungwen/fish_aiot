<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魚菜共生智慧管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .card-header {
            font-weight: bold;
            background-color: #0d6efd;
            color: white;
        }

        .sensor-val {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .sensor-unit {
            font-size: 0.9rem;
            color: #666;
        }

        .video-container {
            background-color: #000;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            flex-direction: column;
        }

        /* 狀態燈號樣式 */
        .status-dot {
            height: 12px;
            width: 12px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            transition: background-color 0.3s;
        }

        .status-online {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid d-flex justify-content-between">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-fish me-2"></i>魚菜共生智慧管理平台</span>

            <div class="d-flex align-items-center">
                <span class="text-white me-3" style="font-size: 0.9rem;">
                    <span id="mqtt-status" class="status-dot"></span>
                    <span id="status-text">未連線</span>
                </span>
                <button id="btn-connect" class="btn btn-outline-light btn-sm" onclick="toggleConnection()">
                    <i class="fas fa-plug"></i> 連線 MQTT
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row g-4 mb-4">
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header"><i class="fas fa-video me-2"></i>即時影像監控</div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            <i class="fas fa-video-slash fa-3x mb-3 text-secondary"></i>
                            <h5>RTSP Stream Source</h5>
                            <p class="text-warning">rtsp://10.197.186.146:554/11</p>
                            <small class="text-muted px-3 text-center">注意：瀏覽器無法直接播放 RTSP 串流，<br>請配合 OBS/VLC 或後端轉碼伺服器
                                (WebRTC) 使用。</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success"><i class="fas fa-chart-line me-2"></i>水質環境監測</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-thermometer-half me-1"></i>水溫</div>
                                    <span id="val_temp" class="sensor-val">--</span> <span class="sensor-unit">°C</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-vial me-1"></i>PH 值</div>
                                    <span id="val_ph" class="sensor-val">--</span> <span class="sensor-unit">pH</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-tint me-1"></i>TDS 水質</div>
                                    <span id="val_tds" class="sensor-val">--</span> <span class="sensor-unit">ppm</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-smog me-1"></i>混濁度</div>
                                    <span id="val_turb" class="sensor-val">--</span> <span class="sensor-unit">V</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-water me-1"></i>水位監測</div>
                                    <div class="progress mt-2" style="height: 25px;">
                                        <div id="bar_level" class="progress-bar bg-info" role="progressbar"
                                            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="4095">
                                            --</div>
                                    </div>
                                    <small class="text-muted">Raw Value: <span id="val_level">--</span></small>
                                </div>
                            </div>
                            <div class="col-12 text-end">
                                <small class="text-muted" id="last-update">最後更新: 等待數據...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary"><i class="fas fa-cogs me-2"></i>環境設備控制</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <span><i class="fas fa-sync-alt me-2 text-primary"></i>循環過濾馬達</span>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-success"
                                    onclick="pub('ttu_fish/relay/pump', 'ON')">開啟</button>
                                <button class="btn btn-outline-danger"
                                    onclick="pub('ttu_fish/relay/pump', 'OFF')">關閉</button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <span><i class="fas fa-temperature-high me-2 text-danger"></i>加溫棒</span>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-success"
                                    onclick="pub('ttu_fish/relay/heater', 'ON')">開啟</button>
                                <button class="btn btn-outline-danger"
                                    onclick="pub('ttu_fish/relay/heater', 'OFF')">關閉</button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-cookie-bite me-2 text-warning"></i>自動餵食器</span>
                            <button class="btn btn-warning text-dark" onclick="pub('ttu_fish/relay/feeder', 'ON')">
                                <i class="fas fa-utensils me-1"></i>立即餵食 (手動)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark"><i class="fas fa-robot me-2"></i>清洗平台控制</div>
                    <div class="card-body text-center">
                        <p class="text-muted mb-3">控制清洗裝置移動或執行自動排程</p>
                        <div class="mb-3">
                            <button class="btn btn-secondary btn-lg mx-1" onclick="pub('ttu_fish/motor1', '1')"><i
                                    class="fas fa-arrow-up"></i> 前進</button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-secondary btn-lg mx-1" onclick="pub('ttu_fish/motor1', '2')"><i
                                    class="fas fa-arrow-down"></i> 後退</button>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-danger flex-grow-1" onclick="pub('ttu_fish/motor1', '0')">
                                <i class="fas fa-stop-circle me-1"></i>緊急停止
                            </button>
                            <button class="btn btn-info text-white flex-grow-1" onclick="pub('ttu_fish/motor1', '3')">
                                <i class="fas fa-magic me-1"></i>一鍵自動清洗
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 text-center text-muted mb-4">
            &copy; 2025 魚菜共生智慧管理系統 | Powered by ESP32, ESP8266 & Python
        </footer>
    </div>

    <script>
        // --- MQTT 設定 ---
        // 建議使用 mqttgo.io (WebSocket 埠口為 8080)
        const BROKER = "mqttgo.io";
        const PORT = 8084;
        const CLIENT_ID = "WebUser_" + parseInt(Math.random() * 100000);
        const TOPIC_SENSORS = "ttu_fish/sensors";

        // 建立客戶端
        let client = new Paho.MQTT.Client(BROKER, PORT, CLIENT_ID);

        // 設定回調函式
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // 連線選項
        const options = {
            onSuccess: onConnect,
            onFailure: onFailure,
            useSSL: false,
            timeout: 5
        };

        // 頁面載入時嘗試連線一次
        console.log("Auto-connecting...");
        toggleConnection();

        // --- 連線控制邏輯 ---
        function toggleConnection() {
            const btn = document.getElementById("btn-connect");
            const statusText = document.getElementById("status-text");

            if (client.isConnected()) {
                console.log("Disconnecting...");
                client.disconnect();
                // onConnectionLost 會被觸發來更新 UI
            } else {
                console.log("Connecting...");
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 連線中...';
                btn.disabled = true;
                statusText.innerText = "連線中...";
                try {
                    client.connect(options);
                } catch (e) {
                    console.error("Connect error:", e);
                    onFailure({ errorMessage: e.message });
                }
            }
        }

        function onConnect() {
            console.log("MQTT Connected");
            // 更新狀態燈號與文字
            document.getElementById("mqtt-status").classList.add("status-online");
            document.getElementById("mqtt-status").classList.remove("status-offline");
            document.getElementById("status-text").innerText = "已連線";

            // 更新按鈕狀態
            const btn = document.getElementById("btn-connect");
            btn.innerHTML = '<i class="fas fa-unlink"></i> 斷開連線';
            btn.classList.remove("btn-outline-light");
            btn.classList.add("btn-danger");
            btn.disabled = false;

            // 訂閱主題
            client.subscribe(TOPIC_SENSORS);
        }

        function onFailure(responseObject) {
            console.log("Connection failed: " + responseObject.errorMessage);
            //alert("MQTT 連線失敗: " + responseObject.errorMessage + "\n請確認網路或 Broker 設定。");

            // 更新 UI 為失敗狀態，讓使用者可以再按一次
            onConnectionLost(responseObject);
        }

        function onConnectionLost(responseObject) {
            // 更新狀態燈號與文字
            document.getElementById("mqtt-status").classList.remove("status-online");
            document.getElementById("mqtt-status").classList.add("status-offline");
            document.getElementById("status-text").innerText = "未連線";

            // 重置按鈕
            const btn = document.getElementById("btn-connect");
            btn.innerHTML = '<i class="fas fa-plug"></i> 連線 MQTT';
            btn.classList.remove("btn-danger");
            btn.classList.add("btn-outline-light");
            btn.disabled = false;

            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
            }
        }

        // --- 訊息處理邏輯 ---
        function onMessageArrived(message) {
            // console.log("Msg: " + message.payloadString);
            try {
                const data = JSON.parse(message.payloadString);

                // 更新數值
                document.getElementById("val_temp").innerText = data.temp ? parseFloat(data.temp).toFixed(1) : "--";
                document.getElementById("val_ph").innerText = data.ph ? parseFloat(data.ph).toFixed(2) : "--";
                document.getElementById("val_tds").innerText = data.tds ? parseInt(data.tds) : "--";
                document.getElementById("val_turb").innerText = data.turbidity ? parseFloat(data.turbidity).toFixed(2) : "--";

                const level = data.level ? parseInt(data.level) : 0;
                document.getElementById("val_level").innerText = level;
                const levelPercent = Math.min((level / 4095) * 100, 100);
                document.getElementById("bar_level").style.width = levelPercent + "%";
                document.getElementById("bar_level").innerText = level;

                // 更新時間
                document.getElementById("last-update").innerText = "最後更新: " + new Date().toLocaleTimeString();
            } catch (e) {
                console.error("JSON Error", e);
            }
        }

        function pub(topic, payload) {
            if (!client.isConnected()) {
                alert("尚未連線到 MQTT Broker，請先點擊右上角「連線」按鈕！");
                return;
            }
            let message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);
        }
    </script>

</body>

</html>