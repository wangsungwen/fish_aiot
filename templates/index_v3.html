<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魚菜共生智慧管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .card-header {
            font-weight: bold;
            color: white;
        }

        .sensor-val {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .sensor-unit {
            font-size: 0.9rem;
            color: #666;
        }

        .video-container {
            background-color: #000;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            flex-direction: column;
        }

        /* 狀態燈號樣式 */
        .status-dot {
            height: 12px;
            width: 12px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            transition: background-color 0.3s;
        }

        .status-online {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }

        .list-group-item {
            cursor: pointer;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark bg-dark mb-4 sticky-top">
        <div class="container-fluid d-flex justify-content-between">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-fish me-2"></i>魚菜共生智慧管理平台</span>

            <div class="d-flex align-items-center">
                <span class="text-white me-3" style="font-size: 0.9rem;">
                    <span id="mqtt-status" class="status-dot"></span>
                    <span id="status-text">未連線</span>
                </span>
                <button id="btn-connect" class="btn btn-outline-light btn-sm" onclick="toggleConnection()">
                    <i class="fas fa-plug"></i> 連線 MQTT
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row g-4 mb-4">
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary"><i class="fas fa-video me-2"></i>即時影像監控</div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            <img src="/video_feed" style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div class="p-3 bg-dark text-white border-top border-secondary">
                            <form id="settings-form" onsubmit="saveSettings(event)">
                                <div class="mb-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-secondary text-white border-secondary"><i
                                                class="fas fa-video"></i></span>
                                        <input type="text" class="form-control bg-dark text-white border-secondary"
                                            id="rtsp_url" placeholder="RTSP 串流網址" required>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-secondary text-white border-secondary"><i
                                                class="fab fa-telegram-plane"></i></span>
                                        <input type="text" class="form-control bg-dark text-white border-secondary"
                                            id="telegram_bot_token" placeholder="Telegram Bot Token" required>
                                    </div>
                                </div>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-secondary text-white border-secondary"><i
                                            class="fas fa-id-badge"></i></span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary"
                                        id="telegram_chat_id" placeholder="Telegram Chat ID" required>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>
                                        儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success"><i class="fas fa-chart-line me-2"></i>水質環境監測 (MQTT即時)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-thermometer-half me-1"></i>水溫</div>
                                    <span id="val_temp" class="sensor-val">--</span> <span class="sensor-unit">°C</span>
                                    <div class="text-danger small mt-1 fw-bold">Alarm: &lt; 20°C</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-vial me-1"></i>PH 值</div>
                                    <span id="val_ph" class="sensor-val">--</span> <span class="sensor-unit">pH</span>
                                    <div class="text-danger small mt-1 fw-bold">Alarm: &lt; 6.0 or &gt; 8.0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-tint me-1"></i>TDS 水質</div>
                                    <span id="val_tds" class="sensor-val">--</span> <span class="sensor-unit">ppm</span>
                                    <div class="text-danger small mt-1 fw-bold">Alarm: &gt; 200 ppm</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-smog me-1"></i>混濁度 (NTU)</div>
                                    <span id="val_ntu" class="sensor-val">--</span> <span class="sensor-unit">NTU</span>
                                    <div class="text-danger small mt-1 fw-bold">Alarm: &gt; 3000 NTU</div>
                                </div>
                                <span id="val_turb" style="display:none;"></span>
                            </div>
                            <div class="col-12">
                                <div class="border rounded p-3 text-center bg-white">
                                    <div class="text-muted mb-1"><i class="fas fa-water me-1"></i>水位監測</div>
                                    <div class="progress mt-2" style="height: 25px;">
                                        <div id="bar_level" class="progress-bar bg-info" role="progressbar"
                                            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="4095">
                                            --</div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <small class="text-muted">Raw: <span id="val_level">--</span></small>
                                        <small class="text-danger fw-bold" id="level-alarm" style="display:none;">⚠️
                                            水位過低!</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 text-end">
                                <small class="text-muted" id="last-update">最後更新: 等待數據...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark"><i class="fas fa-cogs me-2"></i>環境設備控制</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <span><i class="fas fa-sync-alt me-2 text-primary"></i>循環過濾馬達 <span id="status-pump"
                                    class="badge bg-secondary ms-2">未知</span></span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success"
                                    onclick="pub('fish/control/pump', 'ON')">開啟</button>
                                <button type="button" class="btn btn-outline-danger"
                                    onclick="pub('fish/control/pump', 'OFF')">關閉</button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <span><i class="fas fa-temperature-high me-2 text-danger"></i>加溫棒 <span id="status-heater"
                                    class="badge bg-secondary ms-2">未知</span></span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success"
                                    onclick="pub('fish/control/heater', 'ON')">開啟</button>
                                <button type="button" class="btn btn-outline-danger"
                                    onclick="pub('fish/control/heater', 'OFF')">關閉</button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-cookie-bite me-2 text-warning"></i>自動餵食器</span>
                            <button type="button" class="btn btn-warning text-dark"
                                onclick="pub('fish/control/feeder', 'ON')">
                                <i class="fas fa-utensils me-1"></i>立即餵食 (手動)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-warning text-dark"><i class="fas fa-robot me-2"></i>清洗平台控制</div>
                    <div class="card-body text-center">
                        <p class="text-muted mb-3">控制清洗裝置移動或執行自動排程</p>
                        <div class="mb-3">
                            <button class="btn btn-secondary btn-lg mx-1" onclick="pub('fish/control/motor1', '1')"><i
                                    class="fas fa-arrow-up"></i> 前進</button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-secondary btn-lg mx-1" onclick="pub('fish/control/motor1', '2')"><i
                                    class="fas fa-arrow-down"></i> 後退</button>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-danger flex-grow-1" onclick="pub('fish/control/motor1', '0')">
                                <i class="fas fa-stop-circle me-1"></i>停止
                            </button>
                            <button class="btn btn-info text-white flex-grow-1"
                                onclick="pub('fish/control/motor1', '3')">
                                <i class="fas fa-magic me-1"></i>一鍵自動清洗
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-list-ul me-2"></i>系統事件紀錄 (最近 20 筆)
                    </div>
                    <div class="card-body p-0" style="height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0" style="font-size: 0.9rem;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>時間</th>
                                    <th>類型</th>
                                    <th>訊息</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-film me-2"></i>事件錄影回放
                    </div>
                    <div class="card-body">
                        <div class="row h-100">
                            <div class="col-4 border-end" style="height: 260px; overflow-y: auto;">
                                <div class="list-group list-group-flush" id="video-list">
                                    <button class="list-group-item disabled">載入中...</button>
                                </div>
                            </div>
                            <div class="col-8 d-flex flex-column justify-content-center">
                                <video id="video-player" controls class="w-100 rounded bg-black"
                                    style="max-height: 220px;">
                                    您的瀏覽器不支援 Video 標籤。
                                </video>
                                <p class="mt-2 text-center text-muted small text-truncate" id="video-title">請點擊左側列表播放影片
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 text-center text-muted">
            &copy; 2025 魚菜共生智慧管理系統 | Powered by ESP32, ESP8266 & Flask
        </footer>
    </div>

    <script>
        // --- MQTT 設定 ---
        const BROKER = "MQTTGO.io";
        const PORT = 8084; // WSS Port
        const CLIENT_ID = "WebUser_" + parseInt(Math.random() * 100000);

        const TOPIC_SENSORS = "ttu_fish/sensors";

        let client = null;
        try {
            client = new Paho.MQTT.Client(BROKER, PORT, CLIENT_ID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
        } catch (e) {
            console.error("Paho MQTT Client Init Failed:", e);
            alert("MQTT 初始化失敗 (請檢查網路): " + e.message);
        }

        function toggleConnection() {
            const btn = document.getElementById("btn-connect");
            const statusText = document.getElementById("status-text");

            if (client.isConnected()) {
                client.disconnect();
                updateStatus(false);
            } else {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 連線中...';
                btn.disabled = true;
                statusText.innerText = "連線中...";
                try {
                    let newClientId = "WebUser_" + parseInt(Math.random() * 100000);
                    client = new Paho.MQTT.Client(BROKER, PORT, newClientId);
                    client.onConnectionLost = onConnectionLost;
                    client.onMessageArrived = onMessageArrived;

                    const options = {
                        onSuccess: onConnect,
                        onFailure: onFailure,
                        useSSL: true,
                        timeout: 5
                    };
                    client.connect(options);
                } catch (e) {
                    console.error("Connect error:", e);
                    onFailure({ errorMessage: e.message });
                }
            }
        }

        function logEventToServer(eventType, message) {
            fetch('/api/log_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_type: eventType, message: message })
            }).catch(err => console.error("Log upload failed:", err));
        }

        function onConnect() {
            console.log("MQTT Connected");
            updateStatus(true);
            logEventToServer("MQTT", "Web Client Connected");

            client.subscribe(TOPIC_SENSORS);
            client.subscribe("fish/control/#");
        }

        function onFailure(responseObject) {
            console.log("Connection failed: " + responseObject.errorMessage);
            alert("MQTT 連線失敗: " + responseObject.errorMessage);
            updateStatus(false);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
            }
            updateStatus(false);
        }

        function updateStatus(isConnected) {
            const btn = document.getElementById("btn-connect");
            const statusText = document.getElementById("status-text");
            const statusDot = document.getElementById("mqtt-status");

            if (isConnected) {
                statusDot.className = "status-dot status-online";
                statusText.innerText = "已連線 (即時數據)";
                btn.innerHTML = '<i class="fas fa-unlink"></i> 斷開';
                btn.className = "btn btn-danger btn-sm";
                btn.disabled = false;
            } else {
                statusDot.className = "status-dot status-offline";
                statusText.innerText = "未連線";
                btn.innerHTML = '<i class="fas fa-plug"></i> 連線 MQTT';
                btn.className = "btn btn-outline-light btn-sm";
                btn.disabled = false;
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;

            // 1. 處理感測器數據
            if (topic === TOPIC_SENSORS) {
                try {
                    const data = JSON.parse(payload);

                    document.getElementById("val_temp").innerText = data.temp;
                    document.getElementById("val_ph").innerText = data.ph;
                    document.getElementById("val_tds").innerText = data.tds;
                    document.getElementById("val_ntu").innerText = data.ntu;
                    document.getElementById("val_level").innerText = data.level;

                    const rawLevel = parseInt(data.level);
                    const levelPercent = Math.min((rawLevel / 4095) * 100, 100);
                    const bar = document.getElementById("bar_level");
                    const alarm = document.getElementById("level-alarm");

                    bar.style.width = levelPercent + "%";
                    bar.innerText = levelPercent.toFixed(0) + "%";

                    if (levelPercent < 10) {
                        bar.className = "progress-bar bg-danger";
                        if (alarm) alarm.style.display = "inline";
                    } else {
                        bar.className = "progress-bar bg-info";
                        if (alarm) alarm.style.display = "none";
                    }

                    document.getElementById("last-update").innerText = "最後更新: " + new Date().toLocaleTimeString();
                } catch (e) {
                    console.error("JSON Parse Error", e);
                }
            }

            // 2. 處理控制訊號回報
            if (topic.includes("fish/control/pump")) {
                const status = payload;
                const badge = document.getElementById("status-pump");
                if (status === "ON") {
                    badge.className = "badge bg-success ms-2";
                    badge.innerText = "運作中";
                } else if (status === "OFF") {
                    badge.className = "badge bg-danger ms-2";
                    badge.innerText = "已停止";
                }
            }
            if (topic.includes("fish/control/heater")) {
                const status = payload;
                const badge = document.getElementById("status-heater");
                if (status === "ON") {
                    badge.className = "badge bg-success ms-2";
                    badge.innerText = "加熱中";
                } else if (status === "OFF") {
                    badge.className = "badge bg-danger ms-2";
                    badge.innerText = "已停止";
                }
            }
        }

        function pub(topic, payload) {
            if (!client.isConnected()) {
                alert("請先連線 MQTT！");
                return;
            }
            let message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);

            let deviceName = "未知設備";
            if (topic.includes("pump")) deviceName = "循環過濾馬達";
            if (topic.includes("heater")) deviceName = "加溫棒";
            if (topic.includes("feeder")) deviceName = "自動餵食器";
            if (topic.includes("motor1")) deviceName = "清洗平台";

            let action = payload === "ON" ? "開啟" : "關閉";
            if (payload === "1" || payload === "3") action = "前進";
            if (payload === "2" || payload === "4") action = "後退";
            if (payload === "0") action = "停止";
            if (deviceName === "自動餵食器") action = "執行餵食";

            logEventToServer("MANUAL_CONTROL", `${deviceName} -> ${action}`);
        }

        function fetchLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('log-table-body');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暫無紀錄</td></tr>';
                        return;
                    }
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        let badgeClass = "bg-secondary";
                        if (row.event_type === "FEEDER") badgeClass = "bg-warning text-dark";
                        if (row.event_type === "AUTO_CONTROL") badgeClass = "bg-danger"; // 自動控制顯示為紅色
                        if (row.event_type === "VIDEO") badgeClass = "bg-info text-dark";
                        if (row.event_type === "MQTT") badgeClass = "bg-success";

                        tr.innerHTML = `
                        <td class="text-nowrap">${row.timestamp}</td>
                        <td><span class="badge ${badgeClass}">${row.event_type}</span></td>
                        <td>${row.message}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => console.error("Log fetch error:", err));
        }

        function fetchVideos() {
            fetch('/api/videos')
                .then(response => response.json())
                .then(files => {
                    const listGroup = document.getElementById('video-list');
                    listGroup.innerHTML = '';
                    if (files.length === 0) {
                        listGroup.innerHTML = '<button class="list-group-item disabled">無影片存檔</button>';
                        return;
                    }
                    files.forEach(file => {
                        const btn = document.createElement('button');
                        btn.className = 'list-group-item list-group-item-action small';
                        btn.innerHTML = `<i class="fas fa-play-circle me-1"></i> ${file}`;
                        btn.onclick = () => playVideo(file);
                        listGroup.appendChild(btn);
                    });
                })
                .catch(err => console.error("Video fetch error:", err));
        }

        function playVideo(filename) {
            const player = document.getElementById('video-player');
            const title = document.getElementById('video-title');
            player.src = "/static/videos/" + filename;
            title.innerText = "正在播放: " + filename;
            player.play();
        }

        function fetchData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    if (!client.isConnected()) {
                        document.getElementById("val_temp").innerText = data.temp ? parseFloat(data.temp).toFixed(1) : "--";
                        document.getElementById("val_ph").innerText = data.ph ? parseFloat(data.ph).toFixed(2) : "--";
                        document.getElementById("val_tds").innerText = data.tds ? parseInt(data.tds) : "--";
                        document.getElementById("val_ntu").innerText = data.turbidity_ntu ? parseInt(data.turbidity_ntu) : "--";

                        const level = data.water_level ? parseInt(data.water_level) : 0;
                        document.getElementById("val_level").innerText = level;
                        const levelPercent = Math.min((level / 4095) * 100, 100);
                        document.getElementById("bar_level").style.width = levelPercent + "%";
                        document.getElementById("bar_level").innerText = levelPercent.toFixed(0) + "%";

                        document.getElementById("last-update").innerText = "最後更新(API): " + new Date().toLocaleTimeString();
                    }
                })
                .catch(err => console.error("Data fetch error:", err));
        }

        function fetchSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('rtsp_url').value = data.rtsp_url || "";
                    document.getElementById('telegram_bot_token').value = data.telegram_bot_token || "";
                    document.getElementById('telegram_chat_id').value = data.telegram_chat_id || "";
                })
                .catch(err => console.error("Fetch Settings Error:", err));
        }

        function saveSettings(event) {
            event.preventDefault();
            const payload = {
                rtsp_url: document.getElementById('rtsp_url').value,
                telegram_bot_token: document.getElementById('telegram_bot_token').value,
                telegram_chat_id: document.getElementById('telegram_chat_id').value
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ 設定已儲存！部分設定(如 RTSP)可能需要重啟程式才能生效。');
                    } else {
                        alert('❌ 儲存失敗: ' + data.message);
                    }
                })
                .catch(err => alert('❌ 請求錯誤: ' + err));
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM loaded, initializing...");

            fetchLogs();
            fetchVideos();
            fetchData();
            fetchSettings();

            setInterval(fetchLogs, 3000);
            setInterval(fetchVideos, 10000);
            setInterval(fetchData, 5000);

            try {
                if (client) {
                    toggleConnection();
                }
            } catch (e) {
                console.error("Auto-connect Error:", e);
            }
        });
    </script>

</body>

</html>